name: Email Template Drift Check

on:
  pull_request:
    paths:
      - "packages/email/src/emails/**"
      - "packages/email/scripts/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-email-template-drift:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./tooling/github/setup

      - name: Install dependencies
        run: pnpm install

      - name: Build email templates
        run: pnpm --filter @tonik/email export

      - name: Check for drift in html-exports
        id: drift-check
        run: |
          COMMITTED_HASH=$(find packages/email/html-exports -type f -exec sort {} \; -exec cat {} \; | sha256sum | cut -d' ' -f1)

          NEW_HASH=$(find packages/email/html-exports -type f -exec sort {} \; -exec cat {} \; | sha256sum | cut -d' ' -f1)

          if [ "$COMMITTED_HASH" != "$NEW_HASH" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning ::Email template HTML exports are out of sync with source!"
            echo "Please run 'pnpm --filter @tonik/email export' and commit the changes."
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if drift detected
        if: steps.drift-check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Email Template Drift Detected**\n\nThe email template HTML exports are out of sync with the React source files.\n\nPlease run the following command and commit the changes:\n```bash\npnpm --filter @tonik/email export\n```\n\nThis ensures Supabase uses the latest email template changes.'
            })
